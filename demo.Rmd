---
title: "NHTS Summarizer - Demo"
author: "Alex Cates/Anthony Fucci"
date: "December 20, 2016"
output: 
  html_document: 
    css: css/table.css
    theme: united
---

This document will show you how to create aggregate/contingency tables, maps, and other visualizations
using 2009 public use NHTS Data. (*Download here:* <http://nhts.ornl.gov/download.shtml>)

```{r, warning=FALSE, message=FALSE}

# load packages
library(data.table)
library(htmlTable)
library(magrittr) # Not required for analysis, but function chaining helps readability.

# source code
source('make_table.R')
source('make_bar_chart.R')
source('make_html_table.R')
source('cross_tab_table.R')
source('util.R')


```


## Reading and Merging the Data
The first step is to read in the data. Due to the size of the csvs, we will read in only necessary columns using
data.table's `fread` function. We will then merge the weights with the survey data using unique identifiers.

```{r, warning=FALSE, message=FALSE}

# Read variable metadata table
variables <- fread("./data/2009/variables.csv")
# Read variable value lookup table 
labels <- fread("./data/2009/labels.csv")


# There are 100 replicate weight names. Use get_wgt_names to create the vector of names.
wgt_names <- get_wgt_names('DAYWGT') #Using trip weights in this example.

# Read in the datasets containing the variables/keys necessary to perform analysis
per50wt <- fread(
  input = './data/2009/per50wt.csv', 
  select = c('HOUSEID','PERSONID',wgt_names),
  showProgress = F,
  key = c('HOUSEID','PERSONID')
)
DAYV2PUB <- fread(
  input = './data/2009/DAYV2PUB.csv',
  select = c('HOUSEID','PERSONID','FLAG100','HHSIZE','WRKCOUNT','HHVEHCNT','HHSTATE','HHFAMINC','VMT_MILE','TRAVDAY','TRPTRANS','TRIPPURP','STRTTIME','WHYTRP1S'),
  showProgress = F,
  key = c('HOUSEID','PERSONID')
)

# merge the datasets
dt <- DAYV2PUB[per50wt]

invisible(gc()) #garbage collection to help clean memory
```


## Creating Aggregate Tables
We will use the `make_table` function to create weighted aggregate tables. Frequency, Sum, and Average are 
currently supported.

#### 1. Number of Trips by Travel Mode
```{r, warning=FALSE, message=FALSE}

ex1 <- make_table(
  data = dt, 
  agg = 'count',
  factors = 'TRPTRANS',
  wgt_name = 'DAYWGT'
)

ex1 %>%
  use_labels(labels) %>% 
  cross_tab_table(round_digits = 3) %>% 
  make_html_table


invisible(gc())
```

#### 2. Average Driver Vehicle Miles by Trip Purpose Summary
```{r, warning=FALSE, message=FALSE}

dt[, WRKCOUNT := as.character(WRKCOUNT)][as.numeric(WRKCOUNT) >= 4, WRKCOUNT := '4+']

ex2 <- make_table(
  data = dt, 
  agg = 'avg',
  agg_var = 'VMT_MILE',
  factors = 'WHYTRP1S',
  wgt_name = 'DAYWGT',
  subset = 'VMT_MILE >= 0 & WHYTRP1S >= 0',
  variance = 'moe' #Option to get Margin of Error, instead of default Standard Error
)

ex2 %>%
  use_labels(labels) %>% 
  make_bar_chart

invisible(gc())
```


#### 3. Average Person Trip Rate by Travel Day, Household Size and Number of Workers
```{r, warning=FALSE, message=FALSE}

# Put a ceiling on HHSIZE and WRKCOUNT variables
dt[, HHSIZE := as.character(HHSIZE)][as.numeric(HHSIZE) >= 4, HHSIZE := '4+']
dt[, WRKCOUNT := as.character(WRKCOUNT)][as.numeric(WRKCOUNT) >= 4, WRKCOUNT := '4+']

ex3 <- make_table(
  data = dt, 
  agg = 'person_trip_rate',
  factors = c('TRAVDAY','HHSIZE','WRKCOUNT'),
  wgt_name = 'DAYWGT',
  subset = 'FLAG100 == 1'
)

# Create formatted "report-type" html table
ex3 %>%
  use_labels(labels) %>% 
  cross_tab_table(round_digits = 3) %>% 
  make_html_table


invisible(gc())
```


## Creating Interactive Maps

```{r, warning=FALSE, message=FALSE}

source('load_map_layer.R')
source('map(functions).R')

tbl1 <- make_table(
  data = dt, 
  agg = 'person_trip_rate',
  factors = 'HHSTATE',
  wgt_name = 'DAYWGT',
  subset = 'FLAG100 == 1 & WHYTRP1S >= 0'
)

tbl2 <- make_table(
  data = dt, 
  agg = 'person_trip_rate',
  factors = c('HHSTATE','WHYTRP1S'),
  wgt_name = 'DAYWGT',
  subset = 'FLAG100 == 1 & WHYTRP1S >= 0'
)

tbl2 <- use_labels(tbl2, labels, keep = 'WHYTRP1S')

#list of attributes to copy for each factor split
attr_names <- c('response','factors','variance','factors_label','response_labels')

#split the data.table by HHSTATE and create svg for plot of each state
gg_html <- sapply(with(tbl2, split(tbl2, HHSTATE)), function(tbl) {
  
  for(i in attr_names) setattr(tbl, i, attr(tbl2, i))
  g <- make_bar_chart(tbl, interactive = F)
  gsub("'", "\"", g$x$html) #remove single quotes from html string
  
})

#Create column of state names for merging
gg_html <- cbind(STUSPS = attr(gg_html, "names"), tooltip = unlist(gg_html))

#load geom_state_layer
load_map_layer('state_layer')

#Merge tbl1 with state_layer and then merge the tooltip
merged <- merge(x = state_layer, y = tbl1, by.x = 'STUSPS', by.y = 'HHSTATE')
merged <- merge(merged, gg_html, by = 'STUSPS')

geom_state_layer <- geom_polygon_interactive(
  data = merged,
  mapping = aes(
    x = long,
    y = lat,
    group = group,
    tooltip = paste0(NAME,'\n',tooltip),
    fill = DAYWGT,
    use_jquery = TRUE,
    data_id = STATEFP,
    hover_css = "fill:orange"),
  color = "#FFFFFF",
  size = 0.35)

#Create map
map <- ggplot() + 
  geom_state_layer + 
  coord_fixed() + 
  theme_void() + 
  scale_fill_gradient(low = "#f2f0f7", high = "#54278f")

tooltip_css <- "background-color:#F2F2F2;padding:10px;border-radius:10px 20px 10px 20px;"

invisible(gc())
```


#### 3. Average person trip rate by state (Hover to see state breakdown of Average person trip rate by Trip Purpose Summary)
```{r, warning=FALSE, message=FALSE}
map_widget <- ggiraph(code = {print(map)}, zoom_max = 12, tooltip_extra_css  = tooltip_css)
map_widget


invisible(gc())
```
