---
title: "NHTS Summarizer - Demo"
author: "Alex Cates/Anthony Fucci"
date: "December 20, 2016"
output: 
  html_document: 
    css: css/table.css
    theme: united
---

This document will show you how to create aggregate/contingency tables, maps, and other visualizations
using 2009 public use NHTS Data. (*Download here:* <http://nhts.ornl.gov/download.shtml>)

```{r, warning=FALSE, message=FALSE}

# load packages
library(data.table)
library(magrittr) # Not required for analysis, but helpful.

# source code
source('make_table.R')
source('table_add_ons.R')
source('html_tools.R')
source('util.R')

```


## Reading and Merging the Data
The first step is to read in the data. Due to the size of the csvs, we will read in only necessary columns using
data.table's `fread` function. We will then merge the weights with the survey data using unique identifiers.

```{r, warning=FALSE, message=FALSE}

# There are 100 replicate weight names. Use get_wgt_names to create the vector of names.
wgt_names <- get_wgt_names('DAYWGT')

# Read in the two necessary datasets
per50wt <- fread('./data/2009/per50wt.csv', select = c('HOUSEID','PERSONID',wgt_names))
DAYV2PUB <- fread('./data/2009/DAYV2PUB.csv',select = c('HOUSEID','PERSONID','HHFAMINC','VMT_MILE','HHSTATE'))

# Set the appropriate unique identifiers for merging
setkeyv(per50wt, c('HOUSEID','PERSONID'))
setkeyv(DAYV2PUB, c('HOUSEID','PERSONID'))

# merge the datasets
dt <- DAYV2PUB[per50wt, nomatch=0]

```


## Creating Aggregate Tables
We will use the `make_table` function to create weighted aggregate tables. Frequency, Sum, and Average are 
currently supported.

#### 1. Number of trips by derived total household income.
```{r, warning=FALSE, message=FALSE}

ex1 <- make_table(
  data = dt, 
  agg = 'count',
  factors = 'HHFAMINC',
  wgt_name = 'DAYWGT'
)

head(ex1)

```

#### 2. Sum of driver vehicle miles by state
```{r, warning=FALSE, message=FALSE}

ex2 <- make_table(
  data = dt, 
  agg = 'sum',
  agg_var = 'VMT_MILE',
  factors = 'HHSTATE',
  wgt_name = 'DAYWGT',
  subset = 'VMT_MILE >= 0' # Include subset condition. We do not want to calculate missing (-7,-8,-9) responses.
)

head(ex2)

```

#### 3. Average driver vehicle miles by state and derived total household income
```{r, warning=FALSE, message=FALSE}


ex3 <- make_table(
  data = dt, 
  agg = 'avg',
  agg_var = 'VMT_MILE',
  factors = c('HHSTATE','HHFAMINC'),
  wgt_name = 'DAYWGT',
  subset = 'VMT_MILE >= 0',
  variance = 'moe' #Option to get Margin of Error, instead of default Standard Error
)

head(ex3)

```


## Creating HTML Aggregate/Contingency Tables

#### 1. HTML table without variance displayed
```{r, results='asis'}
make_contingency_table(ex3, show_variance = F) %>%
  format_table %>% 
  make_html_table

```

#### 2. HTML table with variance displayed
```{r, results='asis'}
make_contingency_table(ex3) %>%
  format_table %>% 
  make_html_table

```

#### 3. HTML table with row totals
```{r, results='asis'}
make_contingency_table(ex3, show_variance = F) %>%
  add_totals(margin = 1) %>%
  format_table %>% 
  make_html_table

```

#### 4. HTML table with both row and column totals
```{r, results='asis'}
make_contingency_table(ex3, show_variance = F) %>%
  add_totals(margin = 1:2) %>%
  format_table %>% 
  make_html_table

```


## Creating Interactive Maps

```{r, warning=FALSE, message=FALSE}
library(ggplot2)
library(ggiraph)
library(geojsonio)
source("map(functions).R")

nation_layer <- geojson_read("./resources/geography/cb_2015_us_nation_20m(composite).geojson", what = "sp")
nation_layer <- fortify_spatial_data_frame(nation_layer, "id")

state_layer <- geojson_read("./resources/geography/cb_2015_us_state_20m(composite).geojson", what = "sp")
state_layer <- fortify_spatial_data_frame(state_layer, "id")

```


```{r}

tbl1 <- make_table(
  data = dt, 
  agg = 'sum',
  agg_var = 'VMT_MILE',
  factors = 'HHSTATE',
  wgt_name = 'DAYWGT',
  subset = 'VMT_MILE >= 0'
)

tbl2 <- make_table(
  data = dt, 
  agg = 'sum',
  agg_var = 'VMT_MILE',
  factors = c('HHSTATE','HHFAMINC'),
  wgt_name = 'DAYWGT',
  subset = 'VMT_MILE >= 0'
)


gg_list <- lapply(split(tbl2, tbl2$HHSTATE), function(x) {
  
  g <- ggplot(x, aes(x=factor(HHFAMINC), y=VMT_MILE))
  g <- g + geom_bar(stat="identity")
  g <- g + geom_errorbar(aes(ymax = VMT_MILE + se, ymin = VMT_MILE - se), width = 0.25)
  g <- g + labs(x = 'Derived total HH income', y = 'Calculated Trip distance (miles) for Driver Trips')
  g <- g + theme_light()
  g <- ggiraph(code = {print(g)})
  gsub("'", "\"", g$x$html)
  
})

gg_html <- unlist(gg_list)
gg_html <- cbind(STUSPS = attr(gg_html, "names"), tooltip = gg_html)

merged <- merge(x = state_layer, y = tbl1, by.x = 'STUSPS', by.y = 'HHSTATE')
merged <- merge(merged, gg_html, by = 'STUSPS')


geom_nation_layer <- geom_polygon(
  data = nation_layer,
  mapping = aes(
    x = long,
    y = lat,
    group = group),
  fill = "#DDDDDD")

geom_state_layer <- geom_polygon_interactive(
  data = merged,
  mapping = aes(
    x = long,
    y = lat,
    group = group,
    tooltip = paste0(STUSPS, '<br>', tooltip),
    fill = VMT_MILE,
    use_jquery = TRUE,
    data_id = STATEFP,
    hover_css = "fill:orange"),
  color = "#FFFFFF",
  size = 0.35)

map <- ggplot()
map <- map + geom_nation_layer
map <- map + geom_state_layer
map <- map + coord_fixed()
map <- map + theme_void()
map <- map + scale_fill_gradient(low = "#f2f0f7", high = "#54278f")
map_widget <- ggiraph(code = {print(map)}, zoom_max = 12)
map_widget

```
